#!/bin/bash

MPI_RANK=${OMPI_COMM_WORLD_RANK}

output="tracer.out"
while getopts "s:e:o:" opt; do
  case $opt in
    s)  control_start=$OPTARG      ;;
    e)  control_end=$OPTARG   ;;
    o)  output=$OPTARG   ;;
    *)  echo 'error' >&2
        exit 1
  esac
done
shift $(($OPTIND - 1))

echo "Executing application $@, writing to $output"

if [ "$control_start" = "" ] || [ "$control_end" = "" ]; then
  @PINTOOL_PATH@ -t @CMAKE_CURRENT_BINARY_DIR@/pintool/obj-intel64/memtracer.so -o ${output}.${MPI_RANK} -- "$@"
else
  echo "Start tracing at call to $control_start, end tracing at $control_end"
  @PINTOOL_PATH@ -t @CMAKE_CURRENT_BINARY_DIR@/pintool/obj-intel64/memtracer.so -control start:enter_func:${control_start},stop:exit_func:${control_end} -o ${output}.${MPI_RANK} -- "$@"
fi

